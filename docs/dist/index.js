var an=Object.defineProperty;var z=(n,t)=>{for(var e in t)an(n,e,{get:t[e],enumerable:!0})};var Vt={};z(Vt,{MODE:()=>ln,NODE_ENV:()=>cn,SSR:()=>un});var ln="production",cn="production",un=!1;var hn=Vt;window.DEBUG=hn.MODE==="development";var S,ut,pe,de,At={},$t=[],fn=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function q(n,t){for(var e in t)n[e]=t[e];return n}function me(n){var t=n.parentNode;t&&t.removeChild(n)}function A(n,t,e){var r,i,o,s=arguments,a={};for(o in t)o=="key"?r=t[o]:o=="ref"?i=t[o]:a[o]=t[o];if(arguments.length>3)for(e=[e],o=3;o<arguments.length;o++)e.push(s[o]);if(e!=null&&(a.children=e),typeof n=="function"&&n.defaultProps!=null)for(o in n.defaultProps)a[o]===void 0&&(a[o]=n.defaultProps[o]);return St(n,a,r,i,null)}function St(n,t,e,r,i){var o={type:n,props:t,key:e,ref:r,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:i??++S.__v};return S.vnode!=null&&S.vnode(o),o}function Xt(){return{current:null}}function It(n){return n.children}function H(n,t){this.props=n,this.context=t}function ht(n,t){if(t==null)return n.__?ht(n.__,n.__.__k.indexOf(n)+1):null;for(var e;t<n.__k.length;t++)if((e=n.__k[t])!=null&&e.__e!=null)return e.__e;return typeof n.type=="function"?ht(n):null}function _e(n){var t,e;if((n=n.__)!=null&&n.__c!=null){for(n.__e=n.__c.base=null,t=0;t<n.__k.length;t++)if((e=n.__k[t])!=null&&e.__e!=null){n.__e=n.__c.base=e.__e;break}return _e(n)}}function ye(n){(!n.__d&&(n.__d=!0)&&ut.push(n)&&!Gt.__r++||de!==S.debounceRendering)&&((de=S.debounceRendering)||pe)(Gt)}function Gt(){for(var n;Gt.__r=ut.length;)n=ut.sort(function(t,e){return t.__v.__b-e.__v.__b}),ut=[],n.some(function(t){var e,r,i,o,s,a;t.__d&&(s=(o=(e=t).__v).__e,(a=e.__P)&&(r=[],(i=q({},o)).__v=o.__v+1,Wt(a,o,i,e.__n,a.ownerSVGElement!==void 0,o.__h!=null?[s]:null,r,s??ht(o),o.__h),ge(r,o),o.__e!=s&&_e(o)))})}function Le(n,t,e,r,i,o,s,a,c,p){var l,f,d,u,_,g,v,w=r&&r.__k||$t,x=w.length;for(e.__k=[],l=0;l<t.length;l++)if((u=e.__k[l]=(u=t[l])==null||typeof u=="boolean"?null:typeof u=="string"||typeof u=="number"?St(null,u,null,null,u):Array.isArray(u)?St(It,{children:u},null,null,null):u.__b>0?St(u.type,u.props,u.key,null,u.__v):u)!=null){if(u.__=e,u.__b=e.__b+1,(d=w[l])===null||d&&u.key==d.key&&u.type===d.type)w[l]=void 0;else for(f=0;f<x;f++){if((d=w[f])&&u.key==d.key&&u.type===d.type){w[f]=void 0;break}d=null}Wt(n,u,d=d||At,i,o,s,a,c,p),_=u.__e,(f=u.ref)&&d.ref!=f&&(v||(v=[]),d.ref&&v.push(d.ref,null,u),v.push(f,u.__c||_,u)),_!=null?(g==null&&(g=_),typeof u.type=="function"&&u.__k!=null&&u.__k===d.__k?u.__d=c=we(u,c,n):c=ve(n,u,d,w,_,c),p||e.type!=="option"?typeof e.type=="function"&&(e.__d=c):n.value=""):c&&d.__e==c&&c.parentNode!=n&&(c=ht(d))}for(e.__e=g,l=x;l--;)w[l]!=null&&(typeof e.type=="function"&&w[l].__e!=null&&w[l].__e==e.__d&&(e.__d=ht(r,l+1)),be(w[l],w[l]));if(v)for(l=0;l<v.length;l++)xe(v[l],v[++l],v[++l])}function we(n,t,e){var r,i;for(r=0;r<n.__k.length;r++)(i=n.__k[r])&&(i.__=n,t=typeof i.type=="function"?we(i,t,e):ve(e,i,i,n.__k,i.__e,t));return t}function ve(n,t,e,r,i,o){var s,a,c;if(t.__d!==void 0)s=t.__d,t.__d=void 0;else if(e==null||i!=o||i.parentNode==null)t:if(o==null||o.parentNode!==n)n.appendChild(i),s=null;else{for(a=o,c=0;(a=a.nextSibling)&&c<r.length;c+=2)if(a==i)break t;n.insertBefore(i,o),s=o}return s!==void 0?s:i.nextSibling}function pn(n,t,e,r,i){var o;for(o in e)o==="children"||o==="key"||o in t||Mt(n,o,null,e[o],r);for(o in t)i&&typeof t[o]!="function"||o==="children"||o==="key"||o==="value"||o==="checked"||e[o]===t[o]||Mt(n,o,t[o],e[o],r)}function Ee(n,t,e){t[0]==="-"?n.setProperty(t,e):n[t]=e==null?"":typeof e!="number"||fn.test(t)?e:e+"px"}function Mt(n,t,e,r,i){var o;t:if(t==="style")if(typeof e=="string")n.style.cssText=e;else{if(typeof r=="string"&&(n.style.cssText=r=""),r)for(t in r)e&&t in e||Ee(n.style,t,"");if(e)for(t in e)r&&e[t]===r[t]||Ee(n.style,t,e[t])}else if(t[0]==="o"&&t[1]==="n")o=t!==(t=t.replace(/Capture$/,"")),t=t.toLowerCase()in n?t.toLowerCase().slice(2):t.slice(2),n.l||(n.l={}),n.l[t+o]=e,e?r||n.addEventListener(t,o?Ae:Te,o):n.removeEventListener(t,o?Ae:Te,o);else if(t!=="dangerouslySetInnerHTML"){if(i)t=t.replace(/xlink[H:h]/,"h").replace(/sName$/,"s");else if(t!=="href"&&t!=="list"&&t!=="form"&&t!=="download"&&t in n)try{n[t]=e??"";break t}catch(s){}typeof e=="function"||(e!=null&&(e!==!1||t[0]==="a"&&t[1]==="r")?n.setAttribute(t,e):n.removeAttribute(t))}}function Te(n){this.l[n.type+!1](S.event?S.event(n):n)}function Ae(n){this.l[n.type+!0](S.event?S.event(n):n)}function Wt(n,t,e,r,i,o,s,a,c){var p,l,f,d,u,_,g,v,w,x,T,L=t.type;if(t.constructor!==void 0)return null;e.__h!=null&&(c=e.__h,a=t.__e=e.__e,t.__h=null,o=[a]),(p=S.__b)&&p(t);try{t:if(typeof L=="function"){if(v=t.props,w=(p=L.contextType)&&r[p.__c],x=p?w?w.props.value:p.__:r,e.__c?g=(l=t.__c=e.__c).__=l.__E:("prototype"in L&&L.prototype.render?t.__c=l=new L(v,x):(t.__c=l=new H(v,x),l.constructor=L,l.render=mn),w&&w.sub(l),l.props=v,l.state||(l.state={}),l.context=x,l.__n=r,f=l.__d=!0,l.__h=[]),l.__s==null&&(l.__s=l.state),L.getDerivedStateFromProps!=null&&(l.__s==l.state&&(l.__s=q({},l.__s)),q(l.__s,L.getDerivedStateFromProps(v,l.__s))),d=l.props,u=l.state,f)L.getDerivedStateFromProps==null&&l.componentWillMount!=null&&l.componentWillMount(),l.componentDidMount!=null&&l.__h.push(l.componentDidMount);else{if(L.getDerivedStateFromProps==null&&v!==d&&l.componentWillReceiveProps!=null&&l.componentWillReceiveProps(v,x),!l.__e&&l.shouldComponentUpdate!=null&&l.shouldComponentUpdate(v,l.__s,x)===!1||t.__v===e.__v){l.props=v,l.state=l.__s,t.__v!==e.__v&&(l.__d=!1),l.__v=t,t.__e=e.__e,t.__k=e.__k,l.__h.length&&s.push(l);break t}l.componentWillUpdate!=null&&l.componentWillUpdate(v,l.__s,x),l.componentDidUpdate!=null&&l.__h.push(function(){l.componentDidUpdate(d,u,_)})}l.context=x,l.props=v,l.state=l.__s,(p=S.__r)&&p(t),l.__d=!1,l.__v=t,l.__P=n,p=l.render(l.props,l.state,l.context),l.state=l.__s,l.getChildContext!=null&&(r=q(q({},r),l.getChildContext())),f||l.getSnapshotBeforeUpdate==null||(_=l.getSnapshotBeforeUpdate(d,u)),T=p!=null&&p.type===It&&p.key==null?p.props.children:p,Le(n,Array.isArray(T)?T:[T],t,e,r,i,o,s,a,c),l.base=t.__e,t.__h=null,l.__h.length&&s.push(l),g&&(l.__E=l.__=null),l.__e=!1}else o==null&&t.__v===e.__v?(t.__k=e.__k,t.__e=e.__e):t.__e=dn(e.__e,t,e,r,i,o,s,c);(p=S.diffed)&&p(t)}catch(j){t.__v=null,(c||o!=null)&&(t.__e=a,t.__h=!!c,o[o.indexOf(a)]=null),S.__e(j,t,e)}}function ge(n,t){S.__c&&S.__c(t,n),n.some(function(e){try{n=e.__h,e.__h=[],n.some(function(r){r.call(e)})}catch(r){S.__e(r,e.__v)}})}function dn(n,t,e,r,i,o,s,a){var c,p,l,f,d=e.props,u=t.props,_=t.type,g=0;if(_==="svg"&&(i=!0),o!=null){for(;g<o.length;g++)if((c=o[g])&&(c===n||(_?c.localName==_:c.nodeType==3))){n=c,o[g]=null;break}}if(n==null){if(_===null)return document.createTextNode(u);n=i?document.createElementNS("http://www.w3.org/2000/svg",_):document.createElement(_,u.is&&u),o=null,a=!1}if(_===null)d===u||a&&n.data===u||(n.data=u);else{if(o=o&&$t.slice.call(n.childNodes),p=(d=e.props||At).dangerouslySetInnerHTML,l=u.dangerouslySetInnerHTML,!a){if(o!=null)for(d={},f=0;f<n.attributes.length;f++)d[n.attributes[f].name]=n.attributes[f].value;(l||p)&&(l&&(p&&l.__html==p.__html||l.__html===n.innerHTML)||(n.innerHTML=l&&l.__html||""))}if(pn(n,u,d,i,a),l)t.__k=[];else if(g=t.props.children,Le(n,Array.isArray(g)?g:[g],t,e,r,i&&_!=="foreignObject",o,s,n.firstChild,a),o!=null)for(g=o.length;g--;)o[g]!=null&&me(o[g]);a||("value"in u&&(g=u.value)!==void 0&&(g!==n.value||_==="progress"&&!g)&&Mt(n,"value",g,d.value,!1),"checked"in u&&(g=u.checked)!==void 0&&g!==n.checked&&Mt(n,"checked",g,d.checked,!1))}return n}function xe(n,t,e){try{typeof n=="function"?n(t):n.current=t}catch(r){S.__e(r,e)}}function be(n,t,e){var r,i,o;if(S.unmount&&S.unmount(n),(r=n.ref)&&(r.current&&r.current!==n.__e||xe(r,null,t)),e||typeof n.type=="function"||(e=(i=n.__e)!=null),n.__e=n.__d=void 0,(r=n.__c)!=null){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(s){S.__e(s,t)}r.base=r.__P=null}if(r=n.__k)for(o=0;o<r.length;o++)r[o]&&be(r[o],t,e);i!=null&&me(i)}function mn(n,t,e){return this.constructor(n,e)}function Se(n,t,e){var r,i,o;S.__&&S.__(n,t),i=(r=typeof e=="function")?null:e&&e.__k||t.__k,o=[],Wt(t,n=(!r&&e||t).__k=A(It,null,[n]),i||At,At,t.ownerSVGElement!==void 0,!r&&e?[e]:i?null:t.firstChild?$t.slice.call(t.childNodes):null,o,!r&&e?e:i?i.__e:t.firstChild,r),ge(o,n)}S={__e:function(n,t){for(var e,r,i;t=t.__;)if((e=t.__c)&&!e.__)try{if((r=e.constructor)&&r.getDerivedStateFromError!=null&&(e.setState(r.getDerivedStateFromError(n)),i=e.__d),e.componentDidCatch!=null&&(e.componentDidCatch(n),i=e.__d),i)return e.__E=e}catch(o){n=o}throw n},__v:0},H.prototype.setState=function(n,t){var e;e=this.__s!=null&&this.__s!==this.state?this.__s:this.__s=q({},this.state),typeof n=="function"&&(n=n(q({},e),this.props)),n&&q(e,n),n!=null&&this.__v&&(t&&this.__h.push(t),ye(this))},H.prototype.forceUpdate=function(n){this.__v&&(this.__e=!0,n&&this.__h.push(n),ye(this))},H.prototype.render=It,ut=[],pe=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,Gt.__r=0;var _n=A("div",{class:"load-spinner"},A("div",null),A("div",null),A("div",null),A("div",null),A("div",null),A("div",null),A("div",null),A("div",null),A("div",null),A("div",null),A("div",null),A("div",null)),Yt=class extends H{constructor(){super(...arguments);this.state={loading:!0,error:null}}render(){return A("div",{class:"overlay",tabIndex:-1},A("div",{class:"center-container"},this.state.error!==null?A("span",{class:"error"},this.state.error):this.state.loading?_n:""))}get loading(){return this.state.loading}set loading(t){this.state.loading=t,this.forceUpdate()}get error(){return this.state.error}set error(t){this.state.error=t,this.forceUpdate()}},Ie=Yt;var K=-1,Ge=function(){function n(){this.entitySequence=0,this.entities=new Set,this.components={},this.views={}}return n.prototype.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=this.entitySequence++;this.entities.add(r);for(var i=0,o=t.length;i<o;++i)this.emplace(r,t[i]);return r},n.prototype.insert=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];t>this.entitySequence&&(this.entitySequence=t+1),this.entities.add(t);for(var i=0,o=e.length;i<o;++i)this.emplace(t,e[i]);return t},n.prototype.exists=function(t){return this.entities.has(t)},n.prototype.destroy=function(t){for(var e in this.entities.delete(t),this.components){var r=this.components[e],i=r[t];i!==void 0&&i.free!==void 0&&i.free(),delete r[t]}},n.prototype.get=function(t,e){var r=e.name,i=this.components[r];if(i!==void 0)return i[t]},n.prototype.has=function(t,e){var r=e.name,i=this.components[r];return i!==void 0&&i[t]!==void 0},n.prototype.emplace=function(t,e){var r,i=(r=e.name)!==null&&r!==void 0?r:e.constructor.name;if(!this.entities.has(t))throw new Error('Cannot set component "'+i+'" for dead entity ID '+t);this.components[i]==null&&(this.components[i]={}),this.components[i][t]=e},n.prototype.remove=function(t,e){var r=e.name;if(!this.entities.has(t))throw new Error('Cannot remove component "'+r+'" for dead entity ID '+t);if(this.components[r]!==void 0){var i=this.components[r][t];return delete this.components[r][t],i}},n.prototype.size=function(){return this.entities.size},n.prototype.view=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var r="",i=0;i<t.length;++i)r+=t[i].name;if(this.views[r]==null){for(i=0;i<t.length;++i)this.components[t[i].name]===void 0&&(this.components[t[i].name]={});this.views[r]=new yn(this,gn(t))}return this.views[r]},n.prototype.clear=function(){var t,e;try{for(var r=function(s){var a=typeof Symbol=="function"&&Symbol.iterator,c=a&&s[a],p=0;if(c)return c.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&p>=s.length&&(s=void 0),{value:s&&s[p++],done:!s}}};throw new TypeError(a?"Object is not iterable.":"Symbol.iterator is not defined.")}(this.entities.values()),i=r.next();!i.done;i=r.next()){var o=i.value;this.destroy(o)}}catch(s){t={error:s}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}},n.prototype.all=function(){return this.entities.values()},n}(),yn=function(){function n(t,e){this.world=t,this.view=e}return n.prototype.each=function(t){this.view(this.world,t)},n}();function gn(n){for(var t="",e=[],r=0;r<n.length;++r){var i=n[r].name,o=""+i+r;e.push(o),t+="var "+o+' = _$world.components["'+i+`"][entity];
`,t+="if ("+o+` === undefined) continue;
`}var s="";return s+=`for(var entity of _$world.entities.values()) {
`,s+=""+t,s+="if (_$callback(entity,"+function(a,c){for(var p="",l=a.length-1,f=0;f<l;++f)p+=a[f]+c;return p+a[l]}(e,",")+`) === false) return;
`,s+="}",new Function("_$world","_$callback",s)}var qt=function(){function n(){}return n.for=function(t){var e=n.cache[t];return e==null&&(e=Object.defineProperty(function(){},"name",{value:"T$"+t}),n.cache[t]=e),e},n.cache={},n}();function ot(){switch(GL.getError()){case GL.INVALID_ENUM:return"Unacceptable value has been specified for an enumerated argument.";case GL.INVALID_VALUE:return"Numeric argument is out of range.";case GL.INVALID_OPERATION:return"The specified command is not allowed for the current state.";case GL.INVALID_FRAMEBUFFER_OPERATION:return"The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case GL.OUT_OF_MEMORY:return"Not enough memory is left to execute the command.";case GL.CONTEXT_LOST_WEBGL:return"The WebGL context was lost.";default:return null}}function wn(n){switch(n){case"2d":return!!window.CanvasRenderingContext2D;case"bitmaprenderer":return!!window.ImageBitmapRenderingContext;case"webgl":return!!window.WebGLRenderingContext;case"webgl2":return!!window.WebGL2RenderingContext}}var E;(function(n){n.EmptyVertexArray="E1VA",n.UnknownBaseType="U2BT",n.ShaderCompileFailure="S3CF",n.CreateFailure="N4CF",n.ContextAcquireFailure="C5AF",n.UnknownUniformType="U6UT",n.InvalidUniformData="I7UD",n.UnknownArrayType="U8AT",n.Unsupported="U9SP"})(E||(E={}));function vn(n,t){if(!DEBUG)return`GL operation failed. Code: ${n}`;switch(n){case E.EmptyVertexArray:return"Cannot create empty vertex array";case E.UnknownBaseType:return`Unknown base type: ${t.type}`;case E.ShaderCompileFailure:return`[${t.type&&t.type===35633?"VERTEX":"FRAGMENT"} SHADER] Failed to compile:
${t.message}`;case E.CreateFailure:return`Failed to create ${t.what}: ${t.why}`;case E.ContextAcquireFailure:return`Failed to acquire context ${t.contextId}. Supported: ${wn(t.contextId)}`;case E.UnknownUniformType:return`Unknown uniform type: ${t.type}`;case E.InvalidUniformData:return`Attempted to upload ${t.data} to uniform of type ${t.type}`;case E.UnknownArrayType:return`Unknown array type: ${t.type}`;case E.Unsupported:return`${t.what} ${t.plural===!0?"are":"is"} unsupported. ${t.info}`}}var G=class extends Error{constructor(t,e){super(vn(t,e))}};function Me(n,t){if(window.GL)throw new Error("WebGL2 context already exists!");let e=n.getContext("webgl2",t);if(e==null)throw new G(E.ContextAcquireFailure,{contextId:"WebGL2"});window.GL=e}function Re(n){let t=GL.createShader(n);if(!t)throw new G(E.CreateFailure,{what:"Shader",why:ot()});return t}function ke(){let n=GL.createProgram();if(!n)throw new G(E.CreateFailure,{what:"Program",why:ot()});return n}function Ht(){let n=GL.createBuffer();if(!n)throw new G(E.CreateFailure,{what:"Buffer",why:ot()});return n}function Pe(){let n=GL.createVertexArray();if(!n)throw new G(E.CreateFailure,{what:"Vertex Array",why:ot()});return n}function De(){let n=GL.createTexture();if(!n)throw new G(E.CreateFailure,{what:"Texture",why:ot()});return n}var Ne;(function(n){n[n.Static=0]="Static",n[n.Dynamic=1]="Dynamic"})(Ne||(Ne={}));var B=class{constructor(t,e,r,i,o){this.handle=t,this.target=e,this.usage=r,this.byteLength_=i,this.info_=o}get byteLength(){return this.byteLength_}get elementType(){return this.info_?.type}get elementSize(){return this.info_?.elementSize}get elementTypeName(){return this.info_?.typeName}bind(){GL.bindBuffer(this.target,this.handle)}unbind(){GL.bindBuffer(this.target,null)}upload(t,e=-1){if(DEBUG&&this.usage===GL.STATIC_DRAW)throw new Error("Attempted to overwrite static buffer");if(this.info_=Kt(t),this.bind(),e===-1)GL.bufferData(this.target,t,this.usage);else{if(DEBUG&&e<0)throw new Error(`Negative buffer dstOffset (${e}) is invalid`);if(DEBUG&&this.byteLength_<e+t.byteLength)throw new Error(`Buffer overflow: ${e+t.byteLength}/${this.byteLength_}`);GL.bufferSubData(this.target,e,t)}this.unbind()}static static(t,e){let r=Ht();GL.bindBuffer(e,r),GL.bufferData(e,t,GL.STATIC_DRAW),GL.bindBuffer(e,null);let i=t.byteLength,o=Kt(t);return new B(r,e,GL.STATIC_DRAW,i,o)}static dynamic(t,e){let r=Ht(),i=0,o;return t!=null&&(GL.bindBuffer(e,r),typeof t=="number"?(i=t,GL.bufferData(e,t,GL.DYNAMIC_DRAW)):(i=t.byteLength,o=Kt(t),GL.bufferData(e,t,GL.DYNAMIC_DRAW)),GL.bindBuffer(e,null)),new B(r,e,GL.DYNAMIC_DRAW,i,o)}};function Kt(n){switch(!0){case n instanceof ArrayBuffer:return{type:5120,typeName:"Byte",elementSize:1};case n instanceof Uint8Array:return{type:5125,typeName:"Uint8",elementSize:1};case n instanceof Uint16Array:return{type:5125,typeName:"Uint16",elementSize:2};case n instanceof Uint32Array:return{type:5125,typeName:"Uint32",elementSize:4};case n instanceof Int8Array:return{type:5124,typeName:"Int8",elementSize:1};case n instanceof Int16Array:return{type:5124,typeName:"Int16",elementSize:2};case n instanceof Int32Array:return{type:5124,typeName:"Int32",elementSize:4};case n instanceof Float32Array:return{type:5126,typeName:"Float32",elementSize:4};default:throw new G(E.UnknownArrayType,{type:n.constructor.name.slice(0,n.constructor.name.length-"Array".length)})}}function xn(n,t){let e=n[0]-t[0],r=n[0]+t[0],i=n[1]-t[1],o=n[1]+t[1];return[h(e,i),h(r,i),h(r,o),h(e,o)]}function bn(n,t,e){let r=n[0]-t[0],i=n[0]+t[0],o=n[1]-t[1],s=n[1]+t[1];e[0][0]=r,e[0][1]=o,e[1][0]=i,e[1][1]=o,e[2][0]=i,e[2][1]=s,e[3][0]=r,e[3][1]=s}var Oe=class{constructor(t,e){this.origin=t,this.direction=h.sub(e,t)}cast(t){let e=h.inverse(h.clone(this.direction)),r=h((t.center[0]-this.origin[0])*e[0],(t.center[1]-this.origin[1])*e[1]),i=h((t.center[0]+t.half[0]*2-this.origin[0])*e[0],(t.center[1]+t.half[1]*2-this.origin[1])*e[1]);if(Number.isNaN(i[1])||Number.isNaN(i[0])||Number.isNaN(r[1])||Number.isNaN(r[0]))return null;if(r[0]>i[0]){let p=r[0];r[0]=i[0],i[0]=p}if(r[1]>i[1]){let p=r[1];r[1]=i[1],i[1]=p}if(r[0]>i[1]||r[1]>i[0])return null;let o=Math.max(r[0],r[1]);if(Math.min(i[0],i[1])<0)return null;let a=h(this.origin[0]+o*this.direction[0],this.origin[1]+o*this.direction[1]),c=h();return r[0]>r[1]?e[0]<0?c=h(1,0):c=h(-1,0):r[0]<r[1]&&(e[1]<0?c=h(0,1):c=h(0,-1)),{contact:a,normal:c,time:o}}},J=class{constructor(t,e){this.center=t,this.half=e,this.type="aabb",this.dirty_=!1,this.points_=xn(this.center,this.half)}clone(){return new J(h.clone(this.center),h.clone(this.half))}get points(){return this.dirty_&&bn(this.center,this.half,this.points_),this.points_}get top(){return this.center[1]-this.half[1]}get bottom(){return this.center[1]+this.half[1]}get left(){return this.center[0]-this.half[0]}get right(){return this.center[0]+this.half[0]}translate(t){h.add(this.center,t)}scale(t){h.add(this.half,t)}sweep(t,e){let r=e.clone();return r.half[0]+=this.half[0],r.half[1]+=this.half[1],new Oe(this.center,t).cast(e)}static(t){let e=t.center[0]-this.center[0],r=t.half[0]+this.half[0]-Math.abs(e),i=t.center[1]-this.center[1],o=t.half[1]+this.half[1]-Math.abs(i);return r<=0||o<=0?null:r<o?h(-r*Math.sign(e),0):h(0,-o*Math.sign(i))}};Math.EPSILON=1e-6;var Ln=Math.PI/180,En=180/Math.PI;globalThis.Math.rad=function(t){return t*Ln};globalThis.Math.deg=function(t){return t*En};globalThis.Math.clamp=function(t,e,r){return t<=e?e:t>=r?r:t};globalThis.Math.lerp=function(t,e,r){return t*(1-r)+e*r};globalThis.Math.norm=function(t,e,r){return(r-t)/(e-t)};globalThis.Math.fhypot=function(...t){let e=0;for(let r=0;r<t.length;++r)e+=t[r]*t[r];return Math.sqrt(e)};globalThis.Math.rsqrt=function(t){return 1/Math.sqrt(t)};globalThis.Math.ceil2=function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)))};P.invert=function(t){let e=t[0],r=t[1],i=t[2],o=t[3],s=t[4],a=t[5],c=t[6],p=t[7],l=t[8],f=l*s-a*p,d=-l*o+a*c,u=p*o-s*c,_=e*f+r*d+i*u;return _?(_=1/_,t[0]=f*_,t[1]=(-l*r+i*p)*_,t[2]=(a*r-i*s)*_,t[3]=d*_,t[4]=(l*e-i*c)*_,t[5]=(-a*e+i*o)*_,t[6]=u*_,t[7]=(-p*e+r*c)*_,t[8]=(s*e-r*o)*_,t):P()};function P(n=1,t=0,e=0,r=0,i=1,o=0,s=0,a=0,c=1){return[n,t,e,r,i,o,s,a,c]}P.clone=function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]};P.translate=function(t,e){let r=t[0],i=t[1],o=t[2],s=t[3],a=t[4],c=t[5],p=t[6],l=t[7],f=t[8],d=e[0],u=e[1];return t[0]=r,t[1]=i,t[2]=o,t[3]=s,t[4]=a,t[5]=c,t[6]=d*r+u*s+p,t[7]=d*i+u*a+l,t[8]=d*o+u*c+f,t};P.scale=function(t,e){let r=e[0],i=e[1];return t[0]=r*t[0],t[1]=r*t[1],t[2]=r*t[2],t[3]=i*t[3],t[4]=i*t[4],t[5]=i*t[5],t[6]=t[6],t[7]=t[7],t[8]=t[8],t};P.rotate=function(t,e){let r=t[0],i=t[1],o=t[2],s=t[3],a=t[4],c=t[5],p=t[6],l=t[7],f=t[8],d=Math.sin(e),u=Math.cos(e);return t[0]=u*r+d*s,t[1]=u*i+d*a,t[2]=u*o+d*c,t[3]=u*s-d*r,t[4]=u*a-d*i,t[5]=u*c-d*o,t[6]=p,t[7]=l,t[8]=f,t};DEBUG&&(globalThis.m3=P);function V(n=1,t=0,e=0,r=0,i=0,o=1,s=0,a=0,c=0,p=0,l=1,f=0,d=0,u=0,_=0,g=1){return[n,t,e,r,i,o,s,a,c,p,l,f,d,u,_,g]}V.clone=function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]};V.orthographic=function(t,e,r,i,o,s){let a=1/(t-e),c=1/(i-r),p=1/(o-s),l=(t+e)*a,f=(i+r)*c,d=(s+o)*p;return[2*a,0,0,0,0,-2*c,0,0,0,0,2*p,0,l,f,d,1]};V.lookAt=function(t,e,r=[0,1,0]){let i,o,s,a,c,p,l,f,d,u,_=t[0],g=t[1],v=t[2],w=r[0],x=r[1],T=r[2],L=e[0],j=e[1],Et=e[2];if(Math.abs(_-L)<Math.EPSILON&&Math.abs(g-j)<Math.EPSILON&&Math.abs(v-Et)<Math.EPSILON)return V();l=_-L,f=g-j,d=v-Et,u=1/Math.hypot(l,f,d),l*=u,f*=u,d*=u,i=x*d-T*f,o=T*l-w*d,s=w*f-x*l,u=Math.hypot(i,o,s),u?(u=1/u,i*=u,o*=u,s*=u):(i=0,o=0,s=0),a=f*s-d*o,c=d*i-l*s,p=l*o-f*i,u=Math.hypot(a,c,p),u?(u=1/u,a*=u,c*=u,p*=u):(a=0,c=0,p=0);let rt=-(i*_+o*g+s*v),it=-(a*_+c*g+p*v),Tt=-(l*_+f*g+d*v);return[i,a,l,0,o,c,f,0,s,p,d,0,rt,it,Tt,1]};DEBUG&&(globalThis.m4=V);function h(n=0,t=0){return[n,t]}h.clone=function(t){return[t[0],t[1]]};h.add=function(t,e){return t[0]+=e[0],t[1]+=e[1],t};h.sub=function(t,e){return t[0]-=e[0],t[1]-=e[1],t};h.mult=function(t,e){return t[0]*=e[0],t[1]*=e[1],t};h.div=function(t,e){return t[0]/=e[0],t[1]/=e[1],t};h.min=function(t,e){return t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t};h.max=function(t,e){return t[0]=Math.max(t[0],e[0]),t[1]=Math.max(t[1],e[1]),t};h.sign=function(t){return t[0]=Math.sign(t[0]),t[1]=Math.sign(t[1]),t};h.ceil=function(t){return t[0]=Math.ceil(t[0]),t[1]=Math.ceil(t[1]),t};h.floor=function(t){return t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t};h.round=function(t){return t[0]=Math.round(t[0]),t[1]=Math.round(t[1]),t};h.scale=function(t,e){return t[0]*=e,t[1]*=e,t};h.dist=function(t,e){return Math.fhypot(e[0]-t[0],e[1]-t[1])};h.dist2=function(t,e){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])};h.len=function(t){return Math.fhypot(t[0],t[1])};h.len2=function(t){return t[0]*t[0]+t[1]*t[1]};h.clamp=function(t,e,r){return[Math.clamp(t[0],e[0],r[0]),Math.clamp(t[1],e[1],r[1])]};h.negate=function(t){return t[0]=-t[0],t[1]=-t[1],t};h.inverse=function(t){return t[0]=1/t[0],t[1]=1/t[1],t};h.norm=function(t){let e=t[0]*t[0]+t[1]*t[1];return e>0&&(e=1/Math.sqrt(e)),t[0]*=e,t[1]*=e,t};h.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]};h.cross=function(t,e){let r=t[0]*e[1]-t[1]*e[0];return[0,0,r]};h.lerp=function(t,e,r){return[t[0]+r*(e[0]-t[0]),t[1]+r*(e[1]-t[1])]};h.multMat3=function(t,e){return t[0]=e[0]*t[0]+e[3]*t[1]+e[6],t[0]=e[1]*t[0]+e[4]*t[1]+e[7],t};h.rotate=function(t,e,r){let i=t[0]-e[0],o=t[1]-e[1],s=Math.sin(r),a=Math.cos(r);return t[0]=i*a-o*s+e[0],t[1]=i*s+o*a+e[1],t};h.perp=function(t){return[t[1],-t[0]]};h.angle=function(t,e=h(1,0)){let r=Math.sqrt(t[0]*t[0]+t[1]*t[1])*Math.sqrt(e[0]*e[0]+e[1]*e[1]),i=r&&(t[0]*e[0]+t[1]*e[1])/r;return Math.acos(Math.clamp(i,-1,1))};h.zero=function(t){return t[0]=0,t[1]=0,t};h.equals=function(t,e,r=Math.EPSILON){return Math.abs(t[0]-e[0])<r&&Math.abs(t[1]-e[1])<r};h.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]};h.stringify=function(t){return`[${t[0].toFixed(2)}, ${t[1].toFixed(2)}]`};DEBUG&&(globalThis.v2=h);function tt(n=0,t=0,e=0){return[n,t,e]}DEBUG&&(globalThis.v3=tt);function Q(n=0,t=0,e=0,r=0){return[n,t,e,r]}var Tn=/([\w\d]{2})([\w\d]{2})([\w\d]{2})([\w\d]{2})?/;Q.hex=function(t){let e=Tn.exec(t);if(e!=null)return Q(parseInt(e[1],16)/255,parseInt(e[2],16)/255,parseInt(e[3],16)/255,e[4]!=null?parseInt(e[4],16)/255:1);throw new Error(`Could not parse '${t}' as hex string`)};DEBUG&&(globalThis.v4=Q);var Rt=class{constructor(t,e){this.lerp=e,this.current_=t,this.previous_=t}get current(){return this.current_}get previous(){return this.previous_}update(t){this.previous_=this.current_,this.current_=t}reset(t){this.previous_=t,this.current_=t}get(t){return this.lerp(this.previous_,this.current_,t)}};function An(n,t,e){return V.lookAt(n,t,e)}function je(n,t,e,r){let i=n.width/2/r,o=n.height/2/r;return V.orthographic(-i,i,-o,o,t,e)}var Jt=class{constructor(t,e={}){this.viewport=t,this.resize=()=>{this.projection_=je(this.viewport,this.near_,this.far_,this.zoom_)},this.eye_=e.eye!=null?e.eye:tt(0,0,-1),this.center_=e.center!=null?e.center:tt(0,0,0),this.near_=e.near!=null?e.near:-1,this.far_=e.far!=null?e.far:1,this.worldUp_=e.worldUp!=null?e.worldUp:tt(0,1,0),this.zoom_=e.zoom!=null?e.zoom:1,this.projection_=V(),this.view_=V(),this.update(),this.resize(),window.addEventListener("resize",this.resize)}update(){this.view_=An(this.eye_,this.center_,this.worldUp_),this.projection_=je(this.viewport,this.near_,this.far_,this.zoom_)}get view(){return this.view_}get projection(){return this.projection_}get position(){return h(this.eye_[0],this.eye_[1])}set position(t){this.eye_=tt(t[0],t[1],-1),this.center_=tt(t[0],t[1],0),this.update()}get zoom(){return this.zoom_}set zoom(t){this.zoom_=t,this.update()}};var Pt={};z(Pt,{compile:()=>kn});var Ce=class{constructor(n,t){this.id=Ce.ID_SEQUENCE++;let e=Sn(Ue(n,GL.VERTEX_SHADER),Ue(t,GL.FRAGMENT_SHADER));this.program=e,this.uniforms={},this.bind();for(let r=0,i=GL.getProgramParameter(this.program,GL.ACTIVE_UNIFORMS);r<i;++r){let o=GL.getActiveUniform(this.program,r),s=GL.getUniformLocation(e,o.name);this.uniforms[o.name]={name:o.name,size:o.size,type:kt(o.type),location:s,set:In(o.type,s)}}this.unbind()}bind(){GL.useProgram(this.program)}unbind(){GL.useProgram(null)}},W=Ce;W.ID_SEQUENCE=0;function Gn(n){let t=GL.getShaderSource(n),e=GL.getShaderInfoLog(n),r=GL.getShaderParameter(n,GL.SHADER_TYPE);if(t===null)return`
${e}
`;if(e===null)return"Unknown error";let i=e.split(`
`).filter(f=>f.length>1).map(f=>f.replace(/(ERROR:\s)/g,"")).map(f=>f.split(":")).flat().map(f=>f.trim()),[o,s,a]=[parseInt(i[1]),i[2],i[3]],c=t.split(/\n|\r/g);c[0]=`    ${c[0]}`;let p=`${c.length}`.length,l=!1;for(let f=0;f<c.length;++f)if(f===o-1){let d=c[f].match(/\s+/);d!==null&&(c[f]=`${"-".repeat(d[0].length-1)}> ${c[f].trimStart()}`),c[f]=`${" ".repeat(p-`${f+1}`.length)}${f+1} +${c[f]}`}else c[f]=`${" ".repeat(p-`${f+1}`.length)}${f+1} | ${c[f]}`;return c.push(`${" ".repeat(p)} |`),c.push(`${" ".repeat(p)} +-------> ${a}: ${s}`),c.push(""),c.join(`
`)}function Ue(n,t){let e=Re(t);if(GL.shaderSource(e,n),GL.compileShader(e),DEBUG&&GL.getShaderParameter(e,GL.COMPILE_STATUS)===!1)throw new G(E.ShaderCompileFailure,{type:GL.getShaderParameter(e,GL.SHADER_TYPE)===GL.VERTEX_SHADER?"VERTEX":"FRAGMENT",message:Gn(e)}).message;return e}function Sn(n,t){let e=ke();if(GL.attachShader(e,n),GL.attachShader(e,t),GL.linkProgram(e),GL.getProgramParameter(e,35714)===!1){let r=GL.getProgramInfoLog(e);throw new G(E.ShaderCompileFailure,{message:`${r??"Unknown error"}`})}return e}function In(n,t){let e;switch(n){case 5120:case 5122:case 5124:case 35670:case 35678:case 35679:case 35680:case 36289:case 36306:e=["scalar",1,"uniform1i"];break;case 5121:case 5123:case 5125:e=["scalar",1,"uniform1ui"];break;case 35667:case 35671:e=["array",2,"uniform2iv"];break;case 35668:case 35672:e=["array",3,"uniform3iv"];break;case 35669:case 35673:e=["array",4,"uniform4iv"];break;case 5126:e=["scalar",1,"uniform1f"];break;case 35664:e=["array",2,"uniform2fv"];break;case 35665:e=["array",3,"uniform3fv"];break;case 35666:e=["array",4,"uniform4fv"];break;case 36294:e=["array",2,"uniform2uiv"];break;case 36295:e=["array",3,"uniform3uiv"];break;case 36296:e=["array",4,"uniform4uiv"];break;case 35674:e=["matrix",2*2,"uniformMatrix2fv"];break;case 35685:e=["matrix",2*3,"uniformMatrix2x3fv"];break;case 35686:e=["matrix",2*4,"uniformMatrix2x4fv"];break;case 35687:e=["matrix",3*2,"uniformMatrix3x2fv"];break;case 35675:e=["matrix",3*3,"uniformMatrix3fv"];break;case 35688:e=["matrix",3*4,"uniformMatrix3x4fv"];break;case 35689:e=["matrix",4*2,"uniformMatrix4x2fv"];break;case 35690:e=["matrix",4*3,"uniformMatrix4x3fv"];break;case 35676:e=["matrix",4*4,"uniformMatrix4fv"];break;default:throw new G(E.UnknownUniformType,{type:n})}let r=e[2];switch(e[0]){case"scalar":return function(i){if(DEBUG&&typeof i!="number")throw new G(E.InvalidUniformData,{type:kt(n),data:i});GL[r](t,i)};case"array":return function(i){if(DEBUG&&(!Array.isArray(i)||i.length!==e[1]))throw new G(E.InvalidUniformData,{type:kt(n),data:i});GL[r](t,i)};case"matrix":return function(i){if(DEBUG&&(!Array.isArray(i)||i.length!==e[1]))throw new G(E.InvalidUniformData,{type:kt(n),data:i});GL[r](t,!1,i)}}}function kt(n){switch(n){case 5120:return"byte";case 5122:return"short";case 5124:return"int";case 35670:return"bool";case 35678:return"2d float sampler";case 35679:return"3d float sampler";case 36289:return"2d float sampler array";case 36306:return"2d unsigned int sampler";case 35680:return"cube sampler";case 5121:return"unsigned byte";case 5123:return"unsigned short";case 5125:return"unsigned int";case 35667:return"int 2-component vector";case 35668:return"int 3-component vector";case 35669:return"int 4-component vector";case 35671:return"bool 2-component vector";case 35672:return"bool 3-component vector";case 35673:return"bool 4-component vector";case 5126:return"float";case 35664:return"float 2-component vector";case 35665:return"float 3-component vector";case 35666:return"float 4-component vector";case 36294:return"unsigned int 2-component vector";case 36295:return"unsigned int 3-component vector";case 36296:return"unsigned int 4-component vector";case 35674:return"float 2x2 matrix";case 35685:return"float 2x3 matrix";case 35686:return"float 2x4 matrix";case 35675:return"float 3x3 matrix";case 35687:return"float 3x2 matrix";case 35688:return"float 3x4 matrix";case 35676:return"float 4x4 matrix";case 35689:return"float 4x2 matrix";case 35690:return"float 4x3 matrix";default:throw new G(E.UnknownUniformType,{type:n})}}var Mn=`#version 300 es
precision mediump float;
uniform mat4 uVIEW;
uniform mat4 uPROJECTION;
uniform mat3 uMODEL;
uniform vec4 uUV;
layout(location = 0) in vec2 aPOSITION;
layout(location = 1) in vec2 aTEXCOORD;
out vec2 vTEXCOORD;
void main()
{
    vTEXCOORD = aTEXCOORD * uUV.zw + uUV.xy;
    vec3 transformed = uMODEL * vec3(aPOSITION, 1.0);
    gl_Position = uPROJECTION * uVIEW * vec4(transformed.xy, 0.0, 1.0);
}`,Rn=`#version 300 es
precision mediump float;
uniform sampler2D uTEXTURE;
in vec2 vTEXCOORD;
out vec4 oFRAG;
void main()
{
    oFRAG = texture(uTEXTURE, vTEXCOORD);
}`;function kn(){return new W(Mn,Rn)}var Dt={};z(Dt,{compile:()=>Nn});var Pn=`#version 300 es
precision mediump float;

uniform mat4 uVIEW;
uniform mat4 uPROJECTION;
uniform mat3 uMODEL;

layout(location = 0) in vec2 aPOSITION;
layout(location = 1) in vec2 aTEXCOORD;

out vec2 vTEXCOORD;

void main()
{
    //vTEXCOORD = vec2(aTEXCOORD.x, 1.0 - aTEXCOORD.y);
    vTEXCOORD = aTEXCOORD;
    vec3 transformed = uMODEL * vec3(aPOSITION, 1.0);
    gl_Position = uPROJECTION * uVIEW * vec4(transformed.xy, 0.0, 1.0);
}`,Dn=`#version 300 es
precision mediump float;
precision mediump sampler2DArray;

uniform sampler2DArray uATLAS;
uniform uint uTILE;

in vec2 vTEXCOORD;

out vec4 oFRAG;

void main()
{
    vec3 uvw = vec3(vTEXCOORD.x, vTEXCOORD.y, uTILE);
    oFRAG = texture(uATLAS, uvw);
    //oFRAG = vec4(uvw, 1.0);
}`;function Nn(){return new W(Pn,Dn)}var Nt={};z(Nt,{compile:()=>Cn});var On=`#version 300 es
precision mediump float;
uniform mat4 uVIEW;
uniform mat4 uPROJECTION;
layout(location = 0) in vec2 aPOSITION;
layout(location = 1) in vec4 aCOLOR;
out vec4 vColor;
void main()
{
    vColor = aCOLOR;
    gl_Position = uPROJECTION * uVIEW * vec4(aPOSITION, 0.0, 1.0);
}`,jn=`#version 300 es
precision mediump float;
in vec4 vColor;
out vec4 oFragColor;
void main()
{
    oFragColor = vColor;
}`;function Cn(){return new W(On,jn)}var Ot={};z(Ot,{compile:()=>zn});var Un=`#version 300 es
precision mediump float;
uniform mat4 uVIEW;
uniform mat4 uPROJECTION;
layout(location = 0) in vec2 aPOSITION;
layout(location = 1) in vec3 aCOLOR;
out vec3 vColor;
void main()
{
    vColor = aCOLOR;
    gl_Position = uPROJECTION * uVIEW * vec4(aPOSITION.x, aPOSITION.y, 0.0, 1.0);
    // TODO: variable point size
    gl_PointSize = 10.0;
}`,Fn=`#version 300 es
#extension GL_OES_standard_derivatives : enable
precision mediump float;
in vec3 vColor;
out vec4 oFragColor;
void main()
{
    vec2 cxy = 2.0 * gl_PointCoord - 1.0;
    float r = dot(cxy, cxy);
    float delta = fwidth(r);
    float alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);
    oFragColor = vec4(vColor, alpha);
}`;function zn(){return new W(Un,Fn)}var jt={};z(jt,{build:()=>$n});function Fe(n){switch(n){case 5120:return 1;case 5121:return 1;case 35670:return 1;case 5122:return 2;case 5123:return 2;case 5124:return 4;case 5125:return 4;case 5126:return 4;default:throw new G(E.UnknownBaseType,{type:n})}}var ze=class{constructor(n){if(this.buffers=n,this.id=ze.ID_SEQUENCE++,this.handle=Pe(),DEBUG&&n.length===0)throw new G(E.EmptyVertexArray);GL.bindVertexArray(this.handle);let t=0;for(let r=0,i=n.length;r<i;++r){let o=n[r].descriptors;for(let s=0,a=o.length;s<a;++s)t+=o[s].arraySize*Fe(o[s].baseType)}let e=0;for(let r=0,i=n.length;r<i;++r){let o=n[r].buffer,s=n[r].descriptors;o.bind();for(let a=0,c=s.length;a<c;++a)GL.vertexAttribPointer(s[a].location,s[a].arraySize,s[a].baseType,s[a].normalized,t,e),GL.enableVertexAttribArray(s[a].location),e+=s[a].arraySize*Fe(s[a].baseType)}GL.bindVertexArray(null)}bind(){GL.bindVertexArray(this.handle)}unbind(){GL.bindVertexArray(null)}},st=ze;st.ID_SEQUENCE=0;var Bn=[-1,-1,0,0,-1,1,0,1,1,1,1,1,1,-1,1,0],Vn=[0,1,2,2,3,0];function $n(){let n={vertex:B.static(new Float32Array(Bn),GL.ARRAY_BUFFER),index:B.static(new Int32Array(Vn),GL.ELEMENT_ARRAY_BUFFER)};return new st([{buffer:n.vertex,descriptors:[{location:0,arraySize:2,baseType:GL.FLOAT,normalized:!1},{location:1,arraySize:2,baseType:GL.FLOAT,normalized:!1}]},{buffer:n.index,descriptors:[]}])}var Qt=class{constructor(t={}){this.background=Q(0,0,0,1),this.command={tile:(e,r,i,o=[0,0],s=0,a=[1,1])=>{if(DEBUG&&this.camera==null)throw new Error("Renderer has no bound camera");let c=P();P.translate(c,o),P.rotate(c,s),P.scale(c,a);let p={texture:e,tile:i,model:c};this.commands.tile[r]?this.commands.tile[r].push(p):this.commands.tile[r]=[p]},quad:(e,r,i=[0,0],o=[1,1],s=[0,0],a=0,c=[1,1])=>{if(DEBUG&&this.camera==null)throw new Error("Renderer has no bound camera");let p=P();P.translate(p,s),P.rotate(p,a),P.scale(p,c);let l=Q(i[0],i[1],o[0],o[1]),f={texture:e,uv:l,model:p};this.commands.sprite[r]?this.commands.sprite[r].push(f):this.commands.sprite[r]=[f]},line:(e,r,i=[.5,.5,.5,1])=>{if(DEBUG&&this.camera==null)throw new Error("Renderer has no bound camera");this.buffers.line.cpu.push(...e,...i,...r,...i)},point:(e,r=[.5,.5,.5])=>{if(DEBUG&&this.camera==null)throw new Error("Renderer has no bound camera");this.buffers.point.cpu.push(...e,...r)}},this.options={maxLines:t.maxLines??4096*4,maxPoints:t.maxPoints??8192,lineWidth:t.lineWidth??2},this.shaders={tile:Dt.compile(),sprite:Pt.compile(),line:Nt.compile(),point:Ot.compile()},this.commands={tile:[],sprite:[]},this.buffers={point:{cpu:[],gpu:B.dynamic(4*2+4*3*this.options.maxPoints,GL.ARRAY_BUFFER)},line:{cpu:[],gpu:B.dynamic(4*2+4*4*this.options.maxLines,GL.ARRAY_BUFFER)}},this.vao={quad:jt.build(),point:new st([{buffer:this.buffers.point.gpu,descriptors:[{location:0,arraySize:2,baseType:GL.FLOAT,normalized:!1},{location:1,arraySize:3,baseType:GL.FLOAT,normalized:!1}]}]),line:new st([{buffer:this.buffers.line.gpu,descriptors:[{location:0,arraySize:2,baseType:GL.FLOAT,normalized:!1},{location:1,arraySize:4,baseType:GL.FLOAT,normalized:!1}]}])},this.camera=null}flush(){if(DEBUG&&this.camera==null)throw new Error("Renderer has no bound camera");GL.clearColor(...this.background),GL.clear(GL.COLOR_BUFFER_BIT|GL.DEPTH_BUFFER_BIT),GL.lineWidth(this.options.lineWidth??2),GL.enable(GL.BLEND),GL.blendFunc(GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA);{let t=this.shaders.tile;t.bind(),t.uniforms.uVIEW.set(this.camera.view),t.uniforms.uPROJECTION.set(this.camera.projection),t.uniforms.uATLAS.set(0),this.vao.quad.bind();let e=this.commands.tile,r=Object.keys(e).sort((i,o)=>+i-+o);for(let i=0,o=r.length;i<o;++i){let s=e[+r[i]];for(let a=0,c=s.length;a<c;++a)s[a].texture&&s[a].texture.bind(0),t.uniforms.uTILE.set(s[a].tile),t.uniforms.uMODEL.set(s[a].model),GL.drawElements(GL.TRIANGLES,6,GL.UNSIGNED_INT,0)}}{let t=this.shaders.sprite;t.bind(),t.uniforms.uVIEW.set(this.camera.view),t.uniforms.uPROJECTION.set(this.camera.projection),t.uniforms.uTEXTURE.set(0),this.vao.quad.bind();let e=this.commands.sprite,r=Object.keys(e).sort((i,o)=>+i-+o);for(let i=0,o=r.length;i<o;++i){let s=e[+r[i]];for(let a=0,c=s.length;a<c;++a)s[a].texture&&s[a].texture.bind(0),t.uniforms.uUV.set(s[a].uv),t.uniforms.uMODEL.set(s[a].model),GL.drawElements(GL.TRIANGLES,6,GL.UNSIGNED_INT,0)}}this.shaders.line.bind(),this.shaders.line.uniforms.uVIEW.set(this.camera.view),this.shaders.line.uniforms.uPROJECTION.set(this.camera.projection),this.vao.line.bind(),this.buffers.line.gpu.upload(new Float32Array(this.buffers.line.cpu),0),GL.drawArrays(GL.LINES,0,this.buffers.line.cpu.length/6),this.shaders.point.bind(),this.shaders.point.uniforms.uVIEW.set(this.camera.view),this.shaders.point.uniforms.uPROJECTION.set(this.camera.projection),this.vao.point.bind(),this.buffers.point.gpu.upload(new Float32Array(this.buffers.point.cpu),0),GL.drawArrays(GL.POINTS,0,this.buffers.point.cpu.length/5),this.commands.tile=[],this.commands.sprite=[],this.buffers.line.cpu=[],this.buffers.point.cpu=[]}};var at;(function(n){n[n.Image2D=0]="Image2D",n[n.Atlas=1]="Atlas",n[n.Buffer=2]="Buffer"})(at||(at={}));var Zt=class{constructor(n,t,e){this.image=n,this.kind=t,this.options=e,this.onload=null,this.onerror=r=>console.error(`Error while loading texture '${this.image.src}': `,r),this.id=Zt.ID_SEQUENCE++,this.handle=De(),this.image.onload=()=>{switch(this.kind){case 0:this.target=GL.TEXTURE_2D,Be(this.handle,this.image,this.options);break;case 1:this.target=GL.TEXTURE_2D_ARRAY,Wn(this.handle,this.image,this.options);break;case 2:this.target=GL.TEXTURE_2D,Be(this.handle,this.image,this.options);break}this.onload!=null&&this.onload(),this.image.onload=null},this.image.onerror=r=>{this.onerror!=null&&this.onerror(r)}}get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}bind(n){!this.target||(GL.activeTexture(GL.TEXTURE0+n),GL.bindTexture(this.target,this.handle))}static create(n,t){let e;switch(n){case 0:{let r=t.path;e=new Image,e.src=r}break;case 1:{let r=t.path;e=new Image,e.src=r}break;case 2:e=Xn(t.buffer,t.width,t.height);break}return new Zt(e,n,t)}},ft=Zt;ft.ID_SEQUENCE=0;var Z=(()=>document.createElement("canvas").getContext("2d"))();function Xn(n,t,e){Z.canvas.width=t,Z.canvas.height=e,Z.clearRect(0,0,Z.canvas.width,Z.canvas.height);let r=Z.getImageData(0,0,t,e);r.data.set(n),Z.putImageData(r,0,0);let i=new Image;return i.src=Z.canvas.toDataURL(),i}function Be(n,t,e){let r=GL.TEXTURE_2D;GL.bindTexture(r,n),GL.texImage2D(r,0,e.internalFormat??GL.RGBA,e.format??GL.RGBA,e.type??GL.UNSIGNED_BYTE,t),GL.texParameteri(r,GL.TEXTURE_WRAP_S,e.wrap_s??GL.CLAMP_TO_EDGE),GL.texParameteri(r,GL.TEXTURE_WRAP_T,e.wrap_t??GL.CLAMP_TO_EDGE),GL.texParameteri(r,GL.TEXTURE_MIN_FILTER,e.filter_min??GL.NEAREST),GL.texParameteri(r,GL.TEXTURE_MAG_FILTER,e.filter_mag??GL.NEAREST),e.mipmap!==!1&&GL.generateMipmap(r),GL.bindTexture(r,null)}var pt=(()=>document.createElement("canvas").getContext("2d"))();function Wn(n,t,e){let r=GL.TEXTURE_2D_ARRAY,i=e.internalFormat??GL.RGBA,o=e.format??GL.RGBA,s=e.type??GL.UNSIGNED_BYTE,a=t.width/e.tilesize,c=t.height/e.tilesize,p=a*c;pt.canvas.width=e.tilesize,pt.canvas.height=e.tilesize,GL.bindTexture(r,n),GL.texImage3D(r,0,i,e.tilesize,e.tilesize,p,0,o,s,null);for(let l=0;l<a;++l)for(let f=0;f<c;++f){pt.clearRect(0,0,e.tilesize,e.tilesize);let d=l*e.tilesize,u=f*e.tilesize;pt.drawImage(t,d,u,e.tilesize,e.tilesize,0,0,e.tilesize,e.tilesize);let _=pt.getImageData(0,0,e.tilesize,e.tilesize),g=l+f*a;GL.texSubImage3D(r,0,0,0,g,e.tilesize,e.tilesize,1,o,s,_)}GL.texParameteri(r,GL.TEXTURE_WRAP_S,e.wrap_s??GL.CLAMP_TO_EDGE),GL.texParameteri(r,GL.TEXTURE_WRAP_T,e.wrap_t??GL.CLAMP_TO_EDGE),GL.texParameteri(r,GL.TEXTURE_WRAP_R,e.wrap_t??GL.CLAMP_TO_EDGE),GL.texParameteri(r,GL.TEXTURE_MIN_FILTER,e.filter_min??GL.NEAREST),GL.texParameteri(r,GL.TEXTURE_MAG_FILTER,e.filter_mag??GL.NEAREST),e.mipmap!==!1&&GL.generateMipmap(r),GL.bindTexture(r,null)}var dt;(function(n){n[n.Left=-1]="Left",n[n.Right=1]="Right"})(dt||(dt={}));var C=class{constructor(t){this.callbacks={frame:[]},this.spritesheet=t,this.animation_="Idle",this.direction=1,this.lastDirection=1,this.moving=!1,this.jumping=!1,this.frameIndex=0,this.lastAnimationStep=Date.now()}addEventListener(t,e){this.callbacks[t].push(e)}get animations(){return this.spritesheet.animations}set animation(t){DEBUG&&this.spritesheet.ready&&(this.spritesheet.animations==null||this.spritesheet.animations[t]==null)&&console.warn(`Animation ${t} does not exist on spritesheet ${this.spritesheet.path}`),this.animation_!==t&&(this.frameIndex=0,this.lastAnimationStep=Date.now(),this.animation_=t)}get animation(){return this.animation_}get width(){return(this.spritesheet.maxSize?.w??0)/2}get height(){return(this.spritesheet.maxSize?.h??0)/2}draw(t,e,r=h(),i=0,o=h(1,1)){if(!this.spritesheet.loaded_)return;let s=this.spritesheet.animations[this.animation_];if(!s)return;let a=Date.now();if(a-this.lastAnimationStep>s.frames[this.frameIndex].delay){this.lastAnimationStep=a,this.frameIndex+=1;for(let c=0;c<this.callbacks.frame.length;++c)this.callbacks.frame[c](this.animation_,this.frameIndex,s.frames.length);this.frameIndex===s.frames.length&&(this.frameIndex=0)}for(let c of Object.keys(this.spritesheet.layers)){let p=this.spritesheet.layers[c][this.animation_];if(!p)continue;let l=p.frames[this.frameIndex].uv,f=p.frames[this.frameIndex].size;t.command.quad(this.spritesheet.texture,e,[l.x,l.y],[l.w,l.h],[r[0],r[1]-f.h/2],i,[f.w*o[0]*this.direction,f.h*o[1]])}}},Ct=class{constructor(n){if(this.animations=null,this.layers=null,this.texture=null,this.maxSize=null,this.path=n,this.loaded_=!1,Ct.cache.has(n))return Ct.cache.get(n);fetch(n).then(t=>t.json()).then(t=>this.load(t)),Ct.cache.set(n,this)}get ready(){return this.loaded_}load(n){let t=Yn(n,this.path.substr(0,this.path.lastIndexOf("/")));this.animations=t.animations,this.layers=t.layers,this.texture=ft.create(at.Image2D,{path:t.spritesheet,mipmap:!1}),this.maxSize=t.maxSize,this.loaded_=!0,console.log(`Finished loading ${this.path}`,this)}},lt=Ct;lt.cache=new Map;function Yn(n,t){let e={},r={},i={w:0,h:0},o=n.meta,s=o.size.w,a=o.size.h,c=o.frameTags;for(let l of o.layers){r[l.name]={};let f=0;t:for(;f<c.length;){let d=c[f],u=d.name,_=parseInt(d.to)-parseInt(d.from)+1,g=0,v=[];for(let w=0;w<_;++w){let x=`${l.name} ${u} ${w}`;if(!n.frames[x])continue t;let T=n.frames[x],L=T.frame,j=parseFloat(L.x),Et=parseFloat(L.y),rt=parseFloat(L.w),it=parseFloat(L.h),Tt=parseFloat(T.duration);g+=Tt,i.w<rt*2&&(i.w=rt*2),i.h<it*2&&(i.h=it*2);let on={x:j/s,y:Et/a,w:rt/s,h:it/a},sn={w:rt,h:it};v.push({uv:on,size:sn,delay:Tt})}e[u]={frames:v.map(w=>({delay:w.delay})),duration:g},r[l.name][u]={frames:v,duration:g},f+=1}}let p=t+"/"+o.image;return{animations:e,layers:r,spritesheet:p,maxSize:i}}var te=class{constructor(){this.resize=()=>{this.canvas.width=this.canvas.clientWidth*window.devicePixelRatio,this.canvas.height=this.canvas.clientHeight*window.devicePixelRatio,GL.viewport(0,0,this.canvas.width,this.canvas.height)},this.canvas=GL.canvas,this.resize(),window.addEventListener("resize",this.resize)}get width(){return this.canvas.width}get height(){return this.canvas.height}};var Ve=class{constructor(t){this.value=t}},I;(function(n){n[n.Air=0]="Air",n[n.Ground=1]="Ground",n[n.Ladder=2]="Ladder"})(I||(I={}));var qn="test",$=class{constructor(t,e,r){this.position=t,this.rotation=e,this.scale=r}static lerp(t,e,r){let i=h.lerp(t.position,e.position,r),o=Math.lerp(t.rotation,e.rotation,r),s=h.lerp(t.scale,e.scale,r);return new $(i,o,s)}static clone(t){return new $(h.clone(t.position),t.rotation,h.clone(t.scale))}},U=class extends Rt{constructor(t=h(),e=0,r=h()){super(new $(t,e,r),$.lerp);this.level=qn,this.cstate=1}},Ut=class extends Ve{},O=class{constructor(t,e=.9,r=1.9,i=.3,o=3.5,s=9,a=3){this.position=new Rt(t,h.lerp),this.velocity=h(),this.cstate=0,this.acceleration=e,this.friction=r,this.drag=i,this.speed=o,this.jumpSpeed=s,this.ladderSpeed=a}reset(t){this.position.reset(t),this.velocity=h(),this.cstate=0}};var F;(function(n){n.TAG=qt.for("Player");function t(r,i,o,s){return r.insert(i,n.TAG,new C(new lt(o)),new O(s))}n.self=t;function e(r,i,o,s){return r.insert(i,n.TAG,new C(new lt(o)),new U(s,0,h(.5,.5)))}n.insert=e})(F||(F={}));var ee;(function(n){n.TAG=qt.for("Bullet");function t(r,i,o){return r.insert(i,n.TAG,new C(new lt("assets/sprites/bullet.json")),new U(o,Math.rad(45),h(.25,.25)))}n.insert=t;function e(r,i,o,s,a){let c=new U(o,h.angle(s),h(.25,.25)),p=new Ut(h.scale(h.norm(s),5)),l=new C(new lt("assets/sprites/bullet.json")),f=r.insert(i,n.TAG,l,c,p);return l.addEventListener("frame",(d,u,_)=>{d==="Explode"&&u+1===_&&r.destroy(f)}),setTimeout(()=>{l.animation="Explode",p.value[0]=0,p.value[1]=0},a),console.log(f,l,c),f}n.shoot=e})(ee||(ee={}));Array.prototype.equals==null&&(globalThis.Array.prototype.equals=function(n){if(this===n)return!0;if(this==null||n==null||this.length!=n.length)return!1;for(let t=0;t<this.length;++t)if(this[t]!==n[t])return!1;return!0});Array.prototype.front==null&&(globalThis.Array.prototype.front=function(){return this[0]});Array.prototype.back==null&&(globalThis.Array.prototype.back=function(){return this[this.length-1]});Array.prototype.swap==null&&(globalThis.Array.prototype.swap=function(n,t){let e=this[n];this[n]=this[t],this[t]=e});Array.prototype.empty==null&&(globalThis.Array.prototype.empty=function(){return this.length===0});var et={};z(et,{dirname:()=>Kn,join:()=>Jn,resolve:()=>Qn});function $e(n,t){let e="",r=0,i=-1,o=0,s;for(let a=0;a<=n.length;++a){if(a<n.length)s=n.charCodeAt(a);else{if(s===47)break;s=47}if(s===47){if(!(i===a-1||o===1))if(i!==a-1&&o===2){if(e.length<2||r!==2||e.charCodeAt(e.length-1)!==46||e.charCodeAt(e.length-2)!==46){if(e.length>2){let c=e.lastIndexOf("/");if(c!==e.length-1){c===-1?(e="",r=0):(e=e.slice(0,c),r=e.length-1-e.lastIndexOf("/")),i=a,o=0;continue}}else if(e.length===2||e.length===1){e="",r=0,i=a,o=0;continue}}t&&(e.length>0?e+="/..":e="..",r=2)}else e.length>0?e+="/"+n.slice(i+1,a):e=n.slice(i+1,a),r=a-i-1;i=a,o=0}else s===46&&o!==-1?++o:o=-1}return e}function Kn(n){if(n.length===0)return".";let t=n.charCodeAt(0),e=t===47,r=-1,i=!0;for(let o=n.length-1;o>=1;--o)if(t=n.charCodeAt(o),t===47){if(!i){r=o;break}}else i=!1;return r===-1?e?"/":".":e&&r===1?"//":n.slice(0,r)}function Jn(...n){if(n.length===0)return".";let t;for(let e=0;e<n.length;++e){let r=n[e];r.length>0&&(t==null?t=r:t+="/"+r)}return t==null?".":$e(t,!1)}function Qn(...n){let t="",e=!1,r;for(let i=n.length-1;i>=-1&&!e;i--){let o;i>=0?o=n[i]:(r===void 0&&(r=location.pathname),o=r),o.length!==0&&(t=o+"/"+t,e=o.charCodeAt(0)===47)}return t=$e(t,!e),e?t.length>0?"/"+t:"/":t.length>0?t:"."}String.prototype.hash==null&&(globalThis.String.prototype.hash=function(n=0){let t,e=0;for(;e<this.length-(this.length&3);){t=this.charCodeAt(e)&255|(this.charCodeAt(++e)&255)<<8|(this.charCodeAt(++e)&255)<<16|(this.charCodeAt(++e)&255)<<24,++e,t=(t&65535)*3432918353+(((t>>>16)*3432918353&65535)<<16)&4294967295,t=t<<15|t>>>17,t=(t&65535)*461845907+(((t>>>16)*461845907&65535)<<16)&4294967295,n^=t,n=n<<13|n>>>19;let r=(n&65535)*5+(((n>>>16)*5&65535)<<16)&4294967295;n=(r&65535)+27492+(((r>>>16)+58964&65535)<<16)}switch(t=0,this.length&3){case 3:t^=(this.charCodeAt(e+2)&255)<<16;case 2:t^=(this.charCodeAt(e+1)&255)<<8;case 1:t^=this.charCodeAt(e)&255,t=(t&65535)*3432918353+(((t>>>16)*3432918353&65535)<<16)&4294967295,t=t<<15|t>>>17,t=(t&65535)*461845907+(((t>>>16)*461845907&65535)<<16)&4294967295,n^=t}return n^=this.length,n^=n>>>16,n=(n&65535)*2246822507+(((n>>>16)*2246822507&65535)<<16)&4294967295,n^=n>>>13,n=(n&65535)*3266489909+(((n>>>16)*3266489909&65535)<<16)&4294967295,n^=n>>>16,n>>>0});var b;(function(n){n[n.None=0]="None",n[n.Full=1]="Full",n[n.Ladder=2]="Ladder",n[n.Platform=3]="Platform",n[n.SlopeLeft=4]="SlopeLeft",n[n.SlopeRight=5]="SlopeRight",n[n.SlopeLeftBottom=6]="SlopeLeftBottom",n[n.SlopeRightBottom=7]="SlopeRightBottom",n[n.SlopeLeftTop=8]="SlopeLeftTop",n[n.SlopeRightTop=9]="SlopeRightTop"})(b||(b={}));var m=16,y=m/2,mt=[y,y],Zn=63488;var tr=2047;var Xe=class{constructor(t){this.path=t,this.ready=!1,this.onload=null,this.onerror=e=>console.error(`Error while loading tileset '${this.path}': `,e),console.log(`Loading tileset '${this.path}'`),fetch(t).then(e=>e.json()).then(e=>this.load(e))}load(t){let e=et.join(et.dirname(this.path),t.image),r=ft.create(at.Atlas,{path:e,tilesize:m});r.onload=()=>{this.texture=r,this.tiles=t.tiles,this.ready=!0,this.onload!=null&&this.onload(),console.log(`Finished loading tileset '${this.path}': `,this)},r.onerror=this.onerror}},Ft=class{constructor(t){this.path=t,this.ready=!1,this.onload=null,this.onerror=e=>console.error(`Error while loading level '${this.path}': `,e),this.animIndex=0,this.lastAnimStep=Date.now(),console.log(`Loading level '${this.path}'`),fetch(t).then(e=>e.json()).then(e=>this.load(e))}collisionKind(t,e){return this.data.collision[t+e*this.data.width]}render(t,e){t.background=this.data.background;let r=-10;for(let o=0;o<this.data.tile.length;++o)for(let s=0;s<this.data.height;++s)for(let a=0;a<this.data.width;++a){let c=this.data.tile[o][a+s*this.data.width];if(c===0)continue;c-=1;let p=c&Zn,l=this.data.tilesets[p],f=c&tr,d=l.tiles[f]?.anim;d&&d.length>0&&(f=d[this.animIndex%d.length]);let u=h(y+a*m+e[0],y+s*m+e[1]);t.command.tile(l.texture,r++,f,u,0,mt)}let i=Date.now();i-this.lastAnimStep>=150&&(this.animIndex++,this.lastAnimStep=i)}load(t){let e=[];for(let r=0;r<t.tilesets.length;++r)e.push(new Promise((i,o)=>{let s=et.join(et.dirname(this.path),t.tilesets[r]),a=new Xe(s);a.onload=()=>i([r,a]),a.onerror=c=>o(c)}));Promise.all(e).then(r=>{this.data=t;for(let[i,o]of r)this.data.tilesets[i]=o;this.data.background=Q.hex(t.background.substring(1)),this.size={x:this.data.width*m,y:this.data.height*m},this.onload!=null&&this.onload(),this.ready=!0,console.log(`Finished loading level '${this.path}': `,this)})}};var ne={};z(ne,{Button:()=>zt,key:()=>N,mouse:()=>We,update:()=>Ye});var re={};window.addEventListener("keydown",n=>re[n.code]=!0);window.addEventListener("keyup",n=>re[n.code]=!1);var N={isPressed:n=>re[n]??!1},zt;(function(n){n[n.Left=0]="Left",n[n.Middle=1]="Middle",n[n.Right=2]="Right",n[n.Back=3]="Back",n[n.Forward=4]="Forward"})(zt||(zt={}));var ie={[0]:!1,[1]:!1,[2]:!1,[3]:!1,[4]:!1},R={x:0,y:0},X={x:0,y:0};window.addEventListener("mousedown",n=>(ie[n.button]=!0,X.x=R.x,X.y=R.y,R.x=n.clientX,R.y=n.clientY));window.addEventListener("mouseup",n=>(ie[n.button]=!1,X.x=R.x,X.y=R.y,R.x=n.clientX,R.y=n.clientY));window.addEventListener("mousemove",n=>(X.x=R.x,X.y=R.y,R.x=n.clientX,R.y=n.clientY));var We={current:R,isPressed:n=>ie[n]??!1,moved:()=>X.x!==R.x||X.y!==R.y,world:n=>{let t=h.clone(n.world.get(n.player,O).position.current);return{x:R.x+t[0],y:R.y+t[1]}}};function Ye(){X.x=R.x,X.y=R.y}var D=function(){function n(t,e){e===void 0&&(e=0),this.pointer=0,this.arrayView=new Uint8Array(t,e),this.view=new DataView(t,e),this.decoder=new TextDecoder,this.failed=!1}return n.prototype.read_uint8=function(){return this.pointer+=1,this.failed||this.pointer>this.view.byteLength?(this.failed=!0,0):this.view.getUint8(this.pointer-1)},n.prototype.read_uint16=function(){return this.pointer+=2,this.failed||this.pointer>this.view.byteLength?(this.failed=!0,0):this.view.getUint16(this.pointer-2,!0)},n.prototype.read_uint32=function(){return this.pointer+=4,this.failed||this.pointer>this.view.byteLength?(this.failed=!0,0):this.view.getUint32(this.pointer-4,!0)},n.prototype.read_int8=function(){return this.pointer+=1,this.failed||this.pointer>this.view.byteLength?(this.failed=!0,0):this.view.getInt8(this.pointer-1)},n.prototype.read_int16=function(){return this.pointer+=2,this.failed||this.pointer>this.view.byteLength?(this.failed=!0,0):this.view.getInt16(this.pointer-2,!0)},n.prototype.read_int32=function(){return this.pointer+=4,this.failed||this.pointer>this.view.byteLength?(this.failed=!0,0):this.view.getInt32(this.pointer-4,!0)},n.prototype.read_float=function(){return this.pointer+=4,this.failed||this.pointer>this.view.byteLength?(this.failed=!0,0):this.view.getFloat32(this.pointer-4,!0)},n.prototype.read_string=function(t){if(this.pointer+=t,this.failed||this.pointer>this.view.byteLength)return this.failed=!0,"";var e=this.pointer-t;return this.decoder.decode(this.arrayView.slice(e,e+t))},n.prototype.read_bytes=function(t){if(this.pointer+=t,this.failed||this.pointer>this.view.byteLength)return this.failed=!0,new Uint8Array;var e=this.pointer-t;return this.arrayView.slice(e,e+t)},n}(),qe=new(function(){function n(){this.encoder=new TextEncoder,this.byteLength=0,this.buffer=new Uint8Array(1024)}return n.prototype.encode=function(t){return this.byteLength=this.encoder.encodeInto(t,this.buffer).written,this.byteLength},n.prototype.getInto=function(t,e){t.set(this.buffer.slice(0,this.byteLength),e)},n}()),M=function(){function n(t,e){e===void 0&&(e=0),this.pointer=0;var r=t instanceof ArrayBuffer?t:new ArrayBuffer(t??0);this.arrayView=new Uint8Array(r,e),this.view=new DataView(r)}return n.prototype.ensure=function(t){if(!(this.view.byteLength>=this.pointer+t)){var e=new ArrayBuffer(this.view.byteLength+2*t),r=new Uint8Array(e);r.set(this.arrayView),this.arrayView=r,this.view=new DataView(e)}},n.prototype.advance=function(t){return this.pointer+=t,this.pointer-t},n.prototype.write_uint8=function(t){this.ensure(1),this.view.setUint8(this.advance(1),t)},n.prototype.write_uint16=function(t){this.ensure(2),this.view.setUint16(this.advance(2),t,!0)},n.prototype.write_uint32=function(t){this.ensure(4),this.view.setUint32(this.advance(4),t,!0)},n.prototype.write_int8=function(t){this.ensure(1),this.view.setInt8(this.advance(1),t)},n.prototype.write_int16=function(t){this.ensure(2),this.view.setInt16(this.advance(2),t,!0)},n.prototype.write_int32=function(t){this.ensure(4),this.view.setInt32(this.advance(4),t,!0)},n.prototype.write_float=function(t){this.ensure(4),this.view.setFloat32(this.advance(4),t,!0)},n.prototype.write_string=function(t){var e=qe.encode(t);this.ensure(e),qe.getInto(this.arrayView,this.advance(e))},n.prototype.write_bytes=function(t){this.ensure(t.byteLength),this.arrayView.set(t,this.advance(t.byteLength))},n.prototype.finish=function(){return this.view.buffer.slice(0,this.pointer)},n}();var k={};z(k,{Action:()=>oe,Create:()=>gt,Delete:()=>wt,ID_MAX:()=>ae,Id:()=>se,Initial:()=>vt,Name:()=>er,Position:()=>xt,Transfer:()=>bt});var oe={};z(oe,{Id:()=>ct,Move:()=>_t,Use:()=>yt});var _t=class{constructor(t){this.entities=t}static read(t){let e=new D(t),r=Object.create(_t),i=e.read_uint32();r.entities=new Array(i);for(let o=0;o<i;++o){let s={};s.id=e.read_uint32(),s.cstate=e.read_uint8(),s.x=e.read_float(),s.y=e.read_float(),r.entities[o]=s}return e.failed?null:r}write(t){let e=t?new M(t):new M;e.write_uint32(this.entities.length);for(let r=0;r<this.entities.length;++r){let i=this.entities[r];e.write_uint32(i.id),e.write_uint8(i.cstate),e.write_float(i.x),e.write_float(i.y)}return e.finish()}};var yt=class{constructor(t){this.which=t}static read(t){let e=new D(t),r=Object.create(yt),i=e.read_uint32();return r.which=e.read_string(i),e.failed?null:r}write(t){let e=t?new M(t):new M;return e.write_uint32(this.which.length),e.write_string(this.which),e.finish()}};var ct;(function(n){n[n.Move=0]="Move",n[n.Use=1]="Use"})(ct||(ct={}));var gt=class{constructor(t,e){this.id=t,this.position=e}static read(t){let e=new D(t),r=Object.create(gt);r.id=e.read_uint32();let i={};return i.x=e.read_float(),i.y=e.read_float(),r.position=i,e.failed?null:r}write(t){let e=t?new M(t):new M;return e.write_uint32(this.id),e.write_float(this.position.x),e.write_float(this.position.y),e.finish()}};var wt=class{constructor(t){this.id=t}static read(t){let e=new D(t),r=Object.create(wt);return r.id=e.read_uint32(),e.failed?null:r}write(t){let e=t?new M(t):new M;return e.write_uint32(this.id),e.finish()}};var vt=class{constructor(t,e){this.player=t,this.entities=e}static read(t){let e=new D(t),r=Object.create(vt),i={};i.id=e.read_uint32();let o=e.read_uint32();i.level=e.read_string(o);let s={};s.x=e.read_float(),s.y=e.read_float(),i.position=s,r.player=i;let a=e.read_uint32();r.entities=new Array(a);for(let c=0;c<a;++c){let p={};p.id=e.read_uint32();let l={};l.x=e.read_float(),l.y=e.read_float(),p.position=l,r.entities[c]=p}return e.failed?null:r}write(t){let e=t?new M(t):new M;e.write_uint32(this.player.id),e.write_uint32(this.player.level.length),e.write_string(this.player.level),e.write_float(this.player.position.x),e.write_float(this.player.position.y),e.write_uint32(this.entities.length);for(let r=0;r<this.entities.length;++r){let i=this.entities[r];e.write_uint32(i.id),e.write_float(i.position.x),e.write_float(i.position.y)}return e.finish()}};var xt=class{constructor(t,e,r){this.cstate=t,this.x=e,this.y=r}static read(t){let e=new D(t),r=Object.create(xt);return r.cstate=e.read_uint8(),r.x=e.read_float(),r.y=e.read_float(),e.failed?null:r}write(t){let e=t?new M(t):new M;return e.write_uint8(this.cstate),e.write_float(this.x),e.write_float(this.y),e.finish()}};var bt=class{constructor(t,e,r,i){this.level=t,this.x=e,this.y=r,this.entities=i}static read(t){let e=new D(t),r=Object.create(bt),i=e.read_uint32();r.level=e.read_string(i),r.x=e.read_float(),r.y=e.read_float();let o=e.read_uint32();r.entities=new Array(o);for(let s=0;s<o;++s){let a={};a.id=e.read_uint32();let c={};c.x=e.read_float(),c.y=e.read_float(),a.position=c,r.entities[s]=a}return e.failed?null:r}write(t){let e=t?new M(t):new M;e.write_uint32(this.level.length),e.write_string(this.level),e.write_float(this.x),e.write_float(this.y),e.write_uint32(this.entities.length);for(let r=0;r<this.entities.length;++r){let i=this.entities[r];e.write_uint32(i.id),e.write_float(i.position.x),e.write_float(i.position.y)}return e.finish()}};var se;(function(n){n[n.Create=2]="Create",n[n.Delete=3]="Delete",n[n.Initial=4]="Initial",n[n.Position=5]="Position",n[n.Transfer=6]="Transfer"})(se||(se={}));var ae=7,er=Object.freeze({[ct.Move]:"Move",[ct.Use]:"Use",[2]:"Create",[3]:"Delete",[4]:"Initial",[5]:"Position",[6]:"Transfer"});var Bt=2+2,nt=class{constructor(t,e){this.header_={id:t,size:e.byteLength},this.payload_=e}get id(){return this.header_.id}get size(){return this.header_.size}get payload(){return this.payload_}static parse(t){let e=new D(t),r={id:e.read_uint16(),size:e.read_uint16()};return new nt(r.id,t.slice(Bt,t.byteLength))}static verify(t){if(t.byteLength<Bt)return!1;let e=new DataView(t),r=e.getUint16(0,!0),i=e.getUint16(2,!0);return!(r>=ae||t.byteLength-Bt!=i)}static build(t,e){let r=new Uint8Array(Bt+e.byteLength),i=new DataView(r.buffer);return i.setUint16(0,t,!0),i.setUint16(2,e.byteLength,!0),r.set(new Uint8Array(e),4),r.buffer}};var le={[k.Id.Initial]:[k.Initial,function(n,t){n.player=F.self(n.world,t.player.id,"assets/sprites/mushroom.json",h(t.player.position.x,t.player.position.y)),n.level=new Ft(`assets/maps/${t.player.level}.amt`);for(let e=0;e<t.entities.length;++e){let r=t.entities[e];r.id!==n.player&&F.insert(n.world,r.id,"assets/sprites/mushroom.json",h(r.position.x,r.position.y))}}],[k.Id.Create]:[k.Create,function(n,t){console.log("Create",t.id,t.position),F.insert(n.world,t.id,"assets/sprites/mushroom.json",h(t.position.x,t.position.y))}],[k.Id.Delete]:[k.Delete,function(n,t){console.log("Delete",t.id),n.world.destroy(t.id)}],[k.Action.Id.Move]:[k.Action.Move,function(n,t){for(let e=0,r=t.entities.length;e<r;++e){let i=t.entities[e];if(i.id===n.player)continue;let o=n.world.get(i.id,U);o.update(new $([i.x,i.y],o.current.rotation,h.clone(o.current.scale))),o.cstate=i.cstate}}],[k.Id.Transfer]:[k.Transfer,function(n,t){n.world.get(n.player,O).reset(h(t.x,t.y)),n.level=new Ft(`assets/maps/${t.level}.amt`),n.world.view().each(e=>{e!==n.player&&n.world.destroy(e)});for(let e=0;e<t.entities.length;++e){let r=t.entities[e];r.id!==n.player&&F.insert(n.world,r.id,"assets/sprites/mushroom.json",h(r.position.x,r.position.y))}}]};function nr(n,t={}){let e=new WebSocket(`ws://${n}/`,t.credentials),r=!1;return t.timeout&&setTimeout(()=>{r||(t.ontimeout&&t.ontimeout(),e.close(1e3,"Timed out"))},t.timeout),e.binaryType="arraybuffer",e.onopen=i=>{r=!0,t.onopen?t.onopen(i):console.log(`Connected to ${n}`)},e.onclose=t.onclose??(i=>console.log(`Disconnected from ${n}`)),e.onerror=t.onerror??(i=>console.error(i)),e.onmessage=t.onmessage??(i=>console.log(`Message from ${n}: ${i.data}`)),e}var Lt=class{constructor(n,t){this.address=n,this.credentials=t,this._onerror=e=>{this.onerror?this.onerror(e):console.error(e)},this._onclose=e=>{this.onclose?this.onclose(e):console.log(`Disconnected from ${this.address}`)},this._onopen=e=>{this.onconnect?this.onconnect(e):console.log(`Connected to ${this.address}`)},this._onmessage=e=>{this.packets_.push(e.data)},this.packets_=[]}get state(){return this.ws_?.readyState??Lt.CLOSED}get empty(){return this.packets_.empty()}open(n,t){this.ws_=nr(this.address,{timeout:n,credentials:this.credentials,onopen:this._onopen,onclose:this._onclose,onerror:this._onerror,onmessage:this._onmessage,ontimeout:t})}close(){this.state!==Lt.CONNECTING&&this.state!==Lt.OPEN||this.ws_.close()}send(n){this.state===Lt.OPEN&&this.ws_.send(n)}read(){return this.packets_.shift()}readAll(){let n=this;return function*(){for(;!n.empty;)yield n.read()}()}},Y=Lt;Y.CONNECTING=0;Y.OPEN=1;Y.CLOSING=2;Y.CLOSED=3;var Fo=Date.now();var He=Date.now(),ir=250;function Ke(n){if(n.player===K||!n.level||!n.level.ready)return;let t=n.world.get(n.player,O),e=new J(h(),h()),r=new J(t.position.current,mt);for(let i of Object.keys(n.level.data.object)){let o=n.level.data.object[i];switch(o.type){case"portal":{let s=o;e.half=h(s.width/2,s.height/2),e.center=h(s.x+e.half[0],s.y+e.half[1]);let a=Date.now();if(a-He>=ir&&N.isPressed("KeyF")&&r.static(e)){console.log(`use portal '${i}'`);let c=new k.Action.Use(i);n.socket.send(nt.build(k.Action.Id.Use,c.write())),He=a}break}}}}function Je(n){let t=n.socket;if(t.state===Y.OPEN){if(n.world.view(U).each((e,r)=>r.update($.clone(r.current))),!t.empty){let e;for(;e=t.read();){let r=nt.parse(e),i=le[r.id][0];le[r.id][1](n,i.read(r.payload))}}if(n.player!==K){let e=n.world.get(n.player,O);if(e.position.current[0]!==e.position.previous[0]||e.position.current[1]!==e.position.previous[1]){let r=new k.Position(e.cstate,e.position.current[0],e.position.current[1]);t.send(nt.build(k.Id.Position,r.write()))}}}}function ce(n,t,e){switch(e){case b.SlopeLeft:return n-m*t;case b.SlopeRight:return n-m*(1-t);case b.SlopeLeftBottom:return n-y*t;case b.SlopeRightBottom:return n-y*(1-t);case b.SlopeLeftTop:return n-y*t-y;case b.SlopeRightTop:return n-y*(1-t)-y}}function or(n,t,e,r,i,o){let a=(m+n*m-e)/m,c=y+t*m;r.center[0]=n*m+y,r.center[1]=m+ce(c,a,o);let p=i.static(r),l=!1;return p!=null&&(p[1]<0&&(l=!0),i.center[1]+=p[1]),l}var Qe=.69,sr=Qe*10;function Ze(n){if(!n.ready())return;let t=n.world,e=n.player,r=n.level,i=t.get(e,O),o=0;if(i.cstate!==I.Ladder&&!(N.isPressed("KeyA")&&N.isPressed("KeyD"))&&(N.isPressed("KeyA")&&(o=-1),N.isPressed("KeyD")&&(o=1)),o!==0)i.velocity[0]=Math.clamp(i.velocity[0]+i.acceleration*o,-i.speed,i.speed);else{let d=Math.sign(i.velocity[0]),u=i.friction;i.cstate===I.Air&&(u=i.drag);let _=i.velocity[0]-u*d;_*d<0&&(_=0),i.velocity[0]=Math.clamp(_,-i.speed,i.speed)}switch(i.cstate){case I.Air:{i.velocity[1]+=Qe,i.velocity[1]=Math.min(i.velocity[1],sr);break}case I.Ground:{i.velocity[1]=0,N.isPressed("Space")&&(i.cstate=I.Air,i.velocity[1]=-i.jumpSpeed);break}case I.Ladder:{i.velocity[1]=0,N.isPressed("KeyW")&&(i.velocity[1]-=i.ladderSpeed),N.isPressed("KeyS")&&(i.velocity[1]+=i.ladderSpeed);break}}let s=new J(h(i.position.current[0]+i.velocity[0],i.position.current[1]+i.velocity[1]),mt),a=new J(h(),mt),c=s.center[0],p=s.center[0],l=Math.floor(s.center[0]/m),f=Math.floor(s.center[1]/m);switch(i.cstate!==I.Ladder?N.isPressed("KeyW")?r.collisionKind(l,f)===b.Ladder&&(i.cstate=I.Ladder,s.center[0]=l*m+y,i.velocity[0]=0):N.isPressed("KeyS")&&r.collisionKind(l,f+1)===b.Ladder&&(i.cstate=I.Ladder,s.center[0]=l*m+y,s.center[1]+=1,i.velocity[0]=0):N.isPressed("KeyX")&&(i.cstate=I.Air),i.cstate){case I.Air:{let d=Math.floor((s.center[0]-y)/m),u=Math.floor((s.center[0]+y-1)/m),_=Math.floor((s.center[1]-y)/m),g=Math.floor((s.center[1]+y-1)/m),v=!1;for(let w=_;w<=g;++w)for(let x=d;x<=u;++x){let T=r.collisionKind(x,w);switch(T){case b.None:break;case b.Full:{a.center[0]=x*m+y,a.center[1]=w*m+y;let L=s.static(a);L!=null&&(L[1]<0&&(v=!0),s.center[1]+=L[1]);break}case b.Ladder:{if(r.collisionKind(x,w-1)===b.None&&i.position.previous[1]<i.position.current[1]){a.center[0]=x*m+y,a.center[1]=w*m+y;let L=s.static(a);L!=null&&L[1]<0&&(v=!0,s.center[1]+=L[1])}break}case b.Platform:{if(!N.isPressed("KeyS")&&i.position.previous[1]<i.position.current[1]){a.center[0]=x*m+y,a.center[1]=w*m+y;let L=s.static(a);L!=null&&L[1]<0&&(v=!0,s.center[1]+=L[1])}break}case b.SlopeLeft:case b.SlopeRight:case b.SlopeLeftBottom:case b.SlopeRightBottom:case b.SlopeLeftTop:case b.SlopeRightTop:{v=or(x,w,c,a,s,T);break}}}d=Math.floor((s.center[0]-y)/m),u=Math.floor((s.center[0]+y)/m),_=Math.floor((s.center[1]-y)/m),g=Math.floor((s.center[1]+y)/m);for(let w=_;w<=g;++w)for(let x=d;x<=u;++x)switch(r.collisionKind(x,w)){case b.None:break;case b.Full:{a.center[0]=x*m+y,a.center[1]=w*m+y;let T=s.static(a);T!=null&&T[0]!==0&&(s.center[0]+=T[0])}}v&&r.collisionKind(Math.floor(s.center[0]/m),Math.floor(s.center[1]/m)+1)!==b.None&&(i.cstate=I.Ground,i.velocity[1]=0);break}case I.Ground:{let d=Math.floor((s.center[1]+y-1)/m),u=r.collisionKind(l,d),_=Math.floor((s.center[1]+m)/m),g=r.collisionKind(l,_);if(u>=b.SlopeLeft){let w=(m+l*m-c)/m,x=y+d*m;s.center[1]=ce(x,w,u)}else if(g>=b.SlopeLeft){let v=m+l*m,w=s.center[0],x=(v-w)/m,T=y+_*m;s.center[1]=ce(T,x,g)}else{if(s.center[1]=f*m+y,i.velocity[0]<0){let T=l-1,L=f;if(r.collisionKind(T,L)===b.Full){a.center[0]=T*m+y,a.center[1]=L*m+y;let j=s.static(a);j!=null&&(s.center[0]+=j[0])}}else if(i.velocity[0]>0){let T=l+1,L=f;if(r.collisionKind(T,L)===b.Full){a.center[0]=T*m+y,a.center[1]=L*m+y;let j=s.static(a);j!=null&&(s.center[0]+=j[0])}}let v=Math.floor((s.center[0]-y)/m),w=Math.floor((s.center[0]+y)/m),x=Math.floor(s.center[1]/m)+1;r.collisionKind(v,x)===b.None&&r.collisionKind(w,x)===b.None&&(i.cstate=I.Air),N.isPressed("KeyS")&&r.collisionKind(v,x)===b.Platform&&r.collisionKind(w,x)===b.Platform&&(i.cstate=I.Air,i.velocity[1]=5)}break}case I.Ladder:{if(i.velocity[1]<0){let d=l,u=f-1;if(r.collisionKind(d,u)===b.Full){a.center[0]=d*m+y,a.center[1]=u*m+y;let v=s.static(a);v!=null&&(s.center[1]+=v[1])}let _=Math.floor((s.center[1]-y)/m),g=Math.floor((s.center[1]+y)/m);r.collisionKind(d,_)===b.None&&r.collisionKind(d,g)===b.None&&(s.center[1]=g*m+y,i.cstate=I.Ground)}else if(i.velocity[1]>0){let d=l,u=f,_=r.collisionKind(d,u+1);if(_===b.Full){a.center[0]=d*m+y,a.center[1]=(u+1)*m+y;let g=s.static(a);g!=null&&(s.center[1]+=g[1],i.cstate=I.Ground)}else _===b.None&&r.collisionKind(d,u)===b.None&&(i.cstate=I.Air)}break}}s.center[0]-y<0?s.center[0]=y:s.center[0]+y>r.size.x&&(s.center[0]=r.size.x-y),s.center[1]-y<0?s.center[1]=y:s.center[1]+y>r.size.y&&(s.center[1]=r.size.y-y),i.position.update(s.center)}function tn(n,t,e){let r=n.direction;t[0]<0?(r=dt.Left,n.moving=!0):t[0]>0?(r=dt.Right,n.moving=!0):n.moving=!1,n.direction=r,n.jumping=t[1]!==0,n.moving&&n.lastDirection!=n.direction&&(n.lastDirection=n.direction);let i="Idle";e!==I.Ground?i="Jump":n.moving&&(i="Walk"),n.animation=i}function en(n){if(!n.ready())return;let t=n.world,e=n.player;if(t.view(C,U,F.TAG).each((r,i,o)=>{let s=o.previous.position,a=o.current.position,c=h(a[0]-s[0],a[1]-s[1]);tn(i,c,o.cstate)}),e!==K){let r=t.get(e,C),i=t.get(e,O);tn(r,i.velocity,i.cstate)}}var ue=!1;function nn(n){let t=n.update,e=n.render,r=n.rate,i=n.time??globalThis.performance,o=n.frame??globalThis.requestAnimationFrame,s=1e3/r,a=i.now(),c=0,p=e!==void 0?()=>{if(!ue)return;let l=i.now();for(c+=l-a,a=l;c>=s;)t(),c-=s;e(c/s),o(p)}:()=>{if(!ue)return;let l=i.now();for(c+=l-a,a=l;c>=s;)t(),c-=s;o(p)};ue=!0,o(p)}DEBUG&&(window.Input=ne);var he=class{constructor(t,e){this.overlay=e,this.canvas=t,Me(this.canvas,{alpha:!1,depth:!1,stencil:!1,premultipliedAlpha:!0}),this.camera=new Jt(new te,{zoom:4}),this.renderer=new Qt,this.world=new Ge;let r=DEBUG?"localhost:8888":"protected-springs-02493.herokuapp.com";this.socket=new Y("protected-springs-02493.herokuapp.com","test"),this.socket.open(1e3,()=>(console.log("timeout"),this.overlay.error="Connection failed.")),this.socket.onclose=i=>this.overlay.error="Connection dropped.",this.player=K,DEBUG&&(window.Game=this)}ready(){return this.player!==K&&this.level!==void 0&&this.level.ready&&this.socket.state===Y.OPEN}run(){nn({update:()=>this.update(),render:t=>this.draw(this.renderer,this.camera,t),rate:30})}update(){Ye(),Ke(this),Je(this),Ze(this),en(this)}draw(t,e,r){if(this.player===K||!this.level||!this.level.ready)this.overlay.loading||(this.overlay.loading=!0);else{this.overlay.loading&&(this.overlay.loading=!1),t.camera=e;let i=h.negate(this.world.get(this.player,O).position.get(r));this.level.render(t,i),this.world.view(C,U).each((o,s,a)=>{if(o===this.player)return;let c=a.get(r);this.world.has(o,F.TAG)?s.draw(t,0,h(i[0]+c.position[0],i[1]+c.position[1]+8),0,h(.5,.5)):s.draw(t,0,h(i[0]+c.position[0],i[1]+c.position[1]),c.rotation,c.scale)}),this.world.get(this.player,C).draw(t,0,h(0,8),0,h(.5,.5)),t.flush()}}};var fe=class extends H{constructor(){super(...arguments);this.overlayRef=Xt(),this.canvasRef=Xt()}componentDidMount(){if(!this.canvasRef.current)throw new Error("Something went wrong.");if(!this.overlayRef.current)throw new Error("Something went wrong.");new he(this.canvasRef.current,this.overlayRef.current).run()}render(){return A("div",null,A("div",{class:"container rows center-items noselect"},A("canvas",{ref:this.canvasRef,tabIndex:-1,class:"noselect"})),A(Ie,{ref:this.overlayRef}))}},rn=fe;Se(A(rn,null),document.body);
